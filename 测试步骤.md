# 调试邻间故事设计文档显示问题 - 增强版

## ⚠️ 重要提示

现在代码中已添加了**详细的调试日志**，可以帮助我们准确定位问题！

## 测试步骤

1. **打开浏览器控制台**
   - 按 F12 或右键点击页面 → 检查
   - 切换到 "Console"（控制台）标签页
   - 确保控制台设置为显示所有级别的日志（Info, Warn, Error）

2. **清空控制台**
   - 点击控制台左上角的 🚫 图标清空之前的日志

3. **执行正常流程**
   - 输入城市地址（如：长沙 或 哈尔滨中央大街）
   - 等待生成主题
   - 选择3个主题
   - 点击"邻间故事设计文档"

4. **查看控制台输出**
   
   应该看到**完整的调试信息链**：
   
   ```
   【步骤1】函数被调用
   showStoryDocumentContent 被调用
   userLocation: 长沙
   selectedThemes: [Array(3)]
   
   【步骤2】检查必要变量
   开始获取故事内容...
   
   【步骤3】获取综合主线故事
   getCombinedMainStory 被调用: 长沙 [...]
   找到城市匹配: 长沙
   查找主题组合key: 枫声夜语+青砖呼吸录+雾江光书
   可用的组合: ["枫声夜语+青砖呼吸录+雾江光书", ...]
   找到预设的综合故事 (或: 未找到预设的综合故事，将动态生成)
   
   【步骤4】获取各主题展开故事  
   getThemeExpandedStory 被调用: 长沙 枫声夜语
   找到城市匹配: 长沙
   检查主题: 枫声夜语 是否存在expandedStory
   找到主题数据: [...]
   找到展开故事，长度: XXX
   (对每个选中的主题重复)
   
   【步骤5】格式化内容
   formatMarkdownContent: 处理内容，长度= XXX
   (多次调用，每个故事段落一次)
   
   【步骤6】插入HTML
   combinedMainStory: 已获取
   themeStories: {枫声夜语: "...", ...}
   生成的HTML长度: (一个较大的数字，如 8000+)
   HTML已插入到documentContent
   documentContent当前内容: <div class="story-document-container">...
   
   【步骤7】添加事件监听
   交互事件监听器已添加
   关闭按钮监听器已添加
   ```

4. **可能的错误信息**
   如果看到以下错误，请记录完整的错误信息：
   - `未找到文档面板元素` - HTML结构问题
   - `userLocation 未定义` - 变量作用域问题
   - `selectedThemes 未定义或为空` - 变量作用域问题
   - `getCombinedMainStory is not defined` - 函数未加载
   - `getThemeExpandedStory is not defined` - 函数未加载
   - `formatMarkdownContent is not defined` - 格式化函数未加载
   - 其他JavaScript错误

5. **手动测试函数**
   在控制台中输入以下命令进行测试：
   ```javascript
   // 测试全局变量
   console.log('userLocation:', userLocation);
   console.log('selectedThemes:', selectedThemes);
   
   // 测试函数是否存在
   console.log('getCombinedMainStory:', typeof getCombinedMainStory);
   console.log('getThemeExpandedStory:', typeof getThemeExpandedStory);
   console.log('formatMarkdownContent:', typeof formatMarkdownContent);
   console.log('showStoryDocumentContent:', typeof showStoryDocumentContent);
   
   // 手动调用函数
   showStoryDocumentContent();
   ```

## 常见问题排查

### 问题1：函数未定义
**原因**：JavaScript文件加载顺序错误或文件未加载
**解决**：检查 index.html 中的 `<script>` 标签顺序

### 问题2：变量为 undefined
**原因**：变量作用域问题，未声明为全局变量
**解决**：在 story-handlers.js 顶部添加全局变量声明

### 问题3：HTML内容为空
**原因**：模板字符串中有JavaScript错误
**解决**：检查控制台中的具体错误信息

### 问题4：CSS样式问题
**原因**：元素生成但不可见
**解决**：检查元素的 display 属性和可见性

## 请将控制台输出结果告诉我

完成上述测试后，请将控制台中显示的所有信息（包括错误）复制给我，我会根据具体错误进行修复。
